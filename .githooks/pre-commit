#!/bin/sh
# Pre-commit hook: mirrors CI checks locally
# Auto-fixes formatting, then runs clippy/vet/build/test

set -e

echo "=== Pre-commit: Rust formatting ==="
cargo fmt --manifest-path src/client/Cargo.toml -- --check 2>/dev/null
if [ $? -ne 0 ]; then
    echo "Running cargo fmt..."
    cargo fmt --manifest-path src/client/Cargo.toml
    echo "Rust files formatted. Re-staging changed files."
    git add -u src/client/
fi

echo "=== Pre-commit: Go formatting ==="
unformatted=$(gofmt -l src/server/ 2>/dev/null)
if [ -n "$unformatted" ]; then
    echo "Running gofmt..."
    gofmt -w src/server/
    echo "Go files formatted. Re-staging changed files."
    git add -u src/server/
fi

echo "=== Pre-commit: Rust clippy ==="
cargo clippy --manifest-path src/client/Cargo.toml -- -D warnings

echo "=== Pre-commit: Rust build ==="
cargo build --manifest-path src/client/Cargo.toml --release

echo "=== Pre-commit: Rust tests ==="
cargo test --manifest-path src/client/Cargo.toml

echo "=== Pre-commit: Go vet ==="
go vet ./src/server/...

echo "=== Pre-commit: Go build ==="
go build -o target/proof-at-home-server ./src/server

echo "=== Pre-commit: Go tests ==="
go test ./src/server/...

echo "=== All pre-commit checks passed ==="
