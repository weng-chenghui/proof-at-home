<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Submit Contribution — proof-at-home</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/shared.css">
</head>
<body>
    <nav id="navbar"></nav>
    <div class="container">
        <h1>Submit Contribution</h1>
        <div id="msg" class="msg" style="display:none"></div>

        <form id="form" onsubmit="return submitForm(event)">
            <div class="form-group">
                <label for="username">Username</label>
                <input type="text" id="username" required>
            </div>
            <div class="form-group">
                <label for="contribution_id">Contribution ID</label>
                <input type="text" id="contribution_id" required>
            </div>
            <div class="form-group">
                <label for="prover">Prover</label>
                <select id="prover">
                    <option value="">— Select —</option>
                    <option value="Rocq">Rocq</option>
                    <option value="Lean4">Lean4</option>
                    <option value="other">Other...</option>
                </select>
                <input type="text" id="prover_other" placeholder="Enter prover name" style="display:none;margin-top:0.3rem">
            </div>
            <div class="form-group">
                <label>Conjecture IDs</label>
                <div id="conjecture-multiselect" class="conjecture-multiselect">
                    <label class="text-muted" style="padding:0.75rem">Loading conjectures...</label>
                </div>
                <div class="hint">Select the conjectures included in this batch</div>
            </div>
            <div class="form-group">
                <label for="conjectures_attempted">Conjectures Attempted</label>
                <input type="number" id="conjectures_attempted" min="0" value="0">
                <div class="hint">Auto-computed from selection, override if needed</div>
            </div>
            <div class="form-group">
                <label for="conjectures_proved">Conjectures Proved</label>
                <input type="number" id="conjectures_proved" min="0" value="0">
            </div>
            <div class="form-group">
                <label for="total_cost_usd">Total Cost (USD)</label>
                <input type="number" id="total_cost_usd" step="0.01" min="0" value="0">
                <div class="hint">API cost incurred during proving (e.g. from Claude API usage)</div>
            </div>
            <div class="form-group">
                <label for="archive_sha256">Archive SHA256</label>
                <input type="text" id="archive_sha256">
                <div class="hint">SHA-256 hash of your certificate archive file</div>
            </div>
            <div class="form-group">
                <label for="proof_status">Proof Status</label>
                <select id="proof_status">
                    <option value="">— Select —</option>
                    <option value="proved">proved</option>
                    <option value="incomplete">incomplete</option>
                    <option value="unproved">unproved</option>
                </select>
            </div>
            <button type="submit">Submit Batch</button>
        </form>
    </div>
    <script src="/shared.js"></script>
    <script>
        async function loadConjectures() {
            try {
                const problems = await api('GET', '/conjectures');
                const container = document.getElementById('conjecture-multiselect');
                if (!problems || problems.length === 0) {
                    container.innerHTML = '<label class="text-muted" style="padding:0.75rem">No conjectures available</label>';
                    return;
                }
                container.innerHTML = (problems || []).map(p => {
                    const parts = [escapeHtml(p.id)];
                    if (p.title) parts.push(escapeHtml(p.title));
                    if (p.difficulty) parts.push('[' + escapeHtml(p.difficulty) + ']');
                    return `<label><input type="checkbox" value="${escapeHtml(p.id)}" onchange="updateConjectureCounts()"> ${parts.join(' — ')}</label>`;
                }).join('');
            } catch {
                document.getElementById('conjecture-multiselect').innerHTML =
                    '<label class="text-muted" style="padding:0.75rem">Failed to load conjectures</label>';
            }
        }

        function updateConjectureCounts() {
            const checked = document.querySelectorAll('#conjecture-multiselect input:checked');
            document.getElementById('conjectures_attempted').value = checked.length;
        }

        function getSelectedConjectureIds() {
            return Array.from(document.querySelectorAll('#conjecture-multiselect input:checked'))
                .map(cb => cb.value);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (loginGate('form')) return;
            autoFillUsername('username');
            autoGenId('contribution_id');
            loadConjectures();

            // Show/hide "Other" text input for prover
            document.getElementById('prover').addEventListener('change', function() {
                const otherInput = document.getElementById('prover_other');
                if (this.value === 'other') {
                    otherInput.style.display = 'block';
                    otherInput.focus();
                } else {
                    otherInput.style.display = 'none';
                    otherInput.value = '';
                }
            });
        });

        async function submitForm(e) {
            e.preventDefault();
            hideMsg('msg');
            const paSelect = document.getElementById('prover');
            const proverValue = paSelect.value === 'other'
                ? document.getElementById('prover_other').value.trim()
                : paSelect.value;
            const body = {
                username: document.getElementById('username').value.trim(),
                contribution_id: document.getElementById('contribution_id').value.trim(),
                conjectures_attempted: parseInt(document.getElementById('conjectures_attempted').value) || 0,
                conjectures_proved: parseInt(document.getElementById('conjectures_proved').value) || 0,
                total_cost_usd: parseFloat(document.getElementById('total_cost_usd').value) || 0,
                archive_sha256: document.getElementById('archive_sha256').value.trim(),
                prover: proverValue,
                conjecture_ids: getSelectedConjectureIds(),
                proof_status: document.getElementById('proof_status').value
            };
            try {
                await api('POST', '/certificates/batch', body);
                showMsg('msg', 'Batch submitted successfully.', false);
            } catch (e) {
                showMsg('msg', 'Error: ' + (e.error || e.message || 'submission failed'), true);
            }
            return false;
        }
    </script>
</body>
</html>
